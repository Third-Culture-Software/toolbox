version: v1.0
name: Toolbox S2 project
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 5

global_job_config:
  prologue:
    commands:
      # Disconnect from cache server
      - export SEMAPHORE_CACHE_URL=""
      - export SEMAPHORE_CACHE_USERNAME=""
      - checkout
      - bash release/create.sh

blocks:
  - name: Static Code Analysis
    dependencies: []
    task:
      prologue:
        commands:
          - sudo apt-get install shellcheck
      jobs:
        - name: ShellCheck
          commands:
            - shellcheck sem-service || true
            - shellcheck sem-version || true
            - shellcheck cache       || true
            - shellcheck libcheckout || true
            - 'shellcheck sem-service -f gcc | wc -l && [[ "$(shellcheck sem-service -f gcc | wc -l)" -le 76 ]]'
            - 'shellcheck sem-version -f gcc | wc -l && [[ "$(shellcheck sem-version -f gcc | wc -l)" -le 21 ]]'
            - 'shellcheck cache       -f gcc | wc -l && [[ "$(shellcheck cache -f gcc | wc -l)" -le 152 ]]'
            - 'shellcheck libcheckout -f gcc | wc -l && [[ "$(shellcheck libcheckout -f gcc | wc -l)" -le 89 ]]'
            - shellcheck install-package

  - name: Sem Version Tests
    dependencies: []
    task:
      prologue:
        commands:
          - bash release/install_in_tests.sh

      jobs:
        - name: Sem Version
          commands:
            - sem-version firefox 52
            - firefox --version | grep -q 52
            - sem-version firefox 78
            - firefox --version | grep -q 78
            - sem-version ruby 2.5.3
            - ruby --version | grep 2.5.3
            - sem-version ruby 2.5.2
            - ruby --version | grep 2.5.2
            - sem-version ruby 2.5.3
            - ruby --version | grep 2.5.3
            - sem-version ruby 2.3.7
            - ruby --version | grep 2.3.7
            - sem-version c 8
            - gcc --version | grep " 8."
            - sem-version cpp 7
            - gcc --version | grep " 7."
            - sem-version php 7.2.31
            - php -v | grep 7.2.31
            - sem-version php 7.0.33
            - php -v | grep 7.0.33
            - sem-version php 7.4
            - php -v | grep 7.4
            - phpbrew ext install xdebug
            - php -m | grep xdebug
            - sem-version php 7.3.19
            - php -m | grep magick
            - php -m | grep gd
            - php -m | grep imap
            - which composer | grep 7.3.19
            - sem-version elixir 1.7.4
            - time sem-version node 12.16.1
            - node --version | grep 12.16.1
            - nodejs --version | grep 12.16.1
            - time sem-version node 14
            - node --version | grep 14
            - sem-version ruby 2.6.6
            - ruby --version | grep 2.6.6
            - bundler --version | grep 2
            - mkdir ruby_test
            - echo "2.7.2" > ruby_test/.ruby-version
            - cd ruby_test
            - ruby --version| grep 2.7.2
            - sem-version ruby 2.3.7 -f
            - ruby --version| grep 2.3.7
            - kubectl version --client
            - sem-version kubectl 1.15.3
            - kubectl version --client | grep -q 1.15.3

        - name: Erlang change test
          commands:
            - echo "Erlang version"
            - 'erl -eval ''erlang:display(erlang:system_info(otp_release)), halt().''  -noshell'
            - sem-version erlang 20
            - 'erl -eval ''erlang:display(erlang:system_info(otp_release)), halt().''  -noshell'
            - sem-version erlang 21
            - 'erl -eval ''erlang:display(erlang:system_info(otp_release)), halt().''  -noshell'

        - name: scala change test
          commands:
            - echo "actual scala version"
            - scala -version
            - sem-version scala 2.11
            - sem-version scala 2.12

  - name: Sem Service Tests
    dependencies: []
    task:
      prologue:
        commands:
          - bash release/install_in_tests.sh

      jobs:
        - name: Sem service tests
          matrix:
            - env_var: TEST
              values:
                - mysql
                - postgres
                - redis
                - memcached
                - rabbitmq
                - mongodb
                - elasticsearch
                - cassandra
                - rethinkdb
          commands:
            - bash tests/sem_service/$TEST

  - name: 'Bats: Mac'
    dependencies: []
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-xcode11

      prologue:
        commands:
          - source tests/sftp_server/start_on_mac.sh
          - bash release/install_in_tests.sh
          - git submodule init && git submodule update
          - sudo ./tests/support/bats-core/install.sh /usr/local

      jobs:
        - name: 'Bats: Mac'
          matrix:
            - env_var: TEST
              values:
                - tests/macos_cache.bats
                - tests/macos_autocache.bats
                - tests/libcheckout.bats

          commands:
            - bats --tap --timing $TEST

  - name: 'Bats: Docker'
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
        containers:
          - name: main
            image: 'semaphoreci/ruby:2.6.2'
      prologue:
        commands:
          - source tests/sftp_server/start_on_docker.sh
          - bash release/install_in_tests.sh
          - git submodule init && git submodule update
          - sudo ./tests/support/bats-core/install.sh /usr/local
      jobs:
        - name: 'Bats'
          matrix:
            - env_var: TEST
              values:
                - tests/cache.bats
                - tests/libcheckout.bats
          commands:
            - bats --tap --timing $TEST

  - name: 'Bats: Minimal Docker'
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
        containers:
          - name: main
            image: 'semaphoreci/alpine:3.9'
      prologue:
        commands:
          - apk add --update docker openrc
          - source tests/sftp_server/start_on_docker.sh
          - bash release/install_in_tests.sh
          - git submodule init && git submodule update
          - ./tests/support/bats-core/install.sh /usr/local
      jobs:
        - name: 'Bats'
          matrix:
            - env_var: TEST
              values:
                - tests/cache.bats
                - tests/libcheckout.bats
          commands:
            - bats --tap --timing $TEST

  - name: 'Bats: Linux'
    dependencies: []
    task:
      prologue:
        commands:
          - source tests/sftp_server/start_on_linux.sh
          - sudo apt-get install -y python3.8-dev
          - sem-version python 3.8
          - sem-version go 1.13
          - sem-version php 7.3.23
          - bash release/install_in_tests.sh
          - git submodule init && git submodule update
          - sudo ./tests/support/bats-core/install.sh /usr/local
      jobs:
        - name: 'Bats'
          matrix:
            - env_var: TEST
              values:
                - tests/install_package.bats
                - tests/autocache.bats
                - tests/cache.bats
                - tests/libcheckout.bats
                - tests/base.bats
          commands:
            - bats --tap --timing $TEST

  - name: Semaphore Compiler
    dependencies: []
    task:
      prologue:
        commands:
          - bash release/install_in_tests.sh

      jobs:
        - name: Check if installed
          commands:
            - which spc
            - which when

promotions:
  - name: Release
    pipeline_file: release.yml
    auto_promote_on:
      - result: passed
        branch:
          - ^refs/tags/v*
